<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="date" content="2015-09-30" />

<title>Data transformation</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">

/* padding for bootstrap navbar */
body {
  padding-top: 50px;
  padding-bottom: 40px;
}


/* offset scroll position for anchor links (for fixed navbar)  */
.section h2 {
  padding-top: 55px;
  margin-top: -55px;
}
.section h3 {
  padding-top: 55px;
  margin-top: -55px;
}



/* don't use link color in navbar */
.dropdown-menu>li>a {
  color: black;
}

/* some padding for disqus */
#disqus_thread {
  margin-top: 45px;
}

</style>

<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/textmate.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">


<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">singleCellSeq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="license.html">License</a></li>
        <li><a href="https://github.com/jdblischak/singleCellSeq">GitHub</a></li>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">
<h1 class="title">Data transformation</h1>
<h4 class="date"><em>2015-09-30</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#input">Input</a></li>
<li><a href="#pca">PCA</a><ul>
<li><a href="#pca-of-filtered-data">PCA of filtered data</a></li>
<li><a href="#pca-of-standardized-data">PCA of standardized data</a></li>
<li><a href="#pca-of-poisson-glm-transformed-molecule-counts-per-million">PCA of Poisson GLM transformed molecule counts per million</a></li>
<li><a href="#pca-of-final-batch-corrected-data">PCA of final batch-corrected data</a></li>
</ul></li>
<li><a href="#data-transformation-figure">Data transformation figure</a></li>
<li><a href="#session-information">Session information</a></li>
</ul>
</div>

<p><strong>Last updated:</strong> 2016-04-24</p>
<p><strong>Code version:</strong> 74f30e4e4b6c6fea3667336da91b01fb5603564f</p>
<pre class="r"><code>library(&quot;ggplot2&quot;)
library(&quot;cowplot&quot;)
theme_set(theme_bw(base_size = 12))
source(&quot;functions.R&quot;)</code></pre>
<p>This file performs principal components analysis (PCA) and displays the results for the data at each stage of our data transformation pipeline. Furthermore, it quantifies and tests the PCA results using <a href="https://github.com/geekysuavo/pca-utils">pca-utils</a> (commit <a href="https://github.com/geekysuavo/pca-utils/tree/8540ff2c6769031b0505af78f2dcb5703ae09294">8540ff2</a>). The methodology is described in <a href="http://www.ncbi.nlm.nih.gov/pubmed/23079505">Worley et al., 2013</a>. Briefly, the differences between samples are calculated using the squared Mahalanobis distance. The distances are then scaled so that the hypothesis test that the samples from two groups come from separate distributions can be computed with an F-test.</p>
<div id="input" class="section level2">
<h2>Input</h2>
<p>Input filtered annotation.</p>
<pre class="r"><code>anno_filter &lt;- read.table(&quot;../data/annotation-filter.txt&quot;, header = TRUE,
                   stringsAsFactors = FALSE)
head(anno_filter)</code></pre>
<pre><code>  individual replicate well      batch      sample_id
1    NA19098        r1  A01 NA19098.r1 NA19098.r1.A01
2    NA19098        r1  A02 NA19098.r1 NA19098.r1.A02
3    NA19098        r1  A04 NA19098.r1 NA19098.r1.A04
4    NA19098        r1  A05 NA19098.r1 NA19098.r1.A05
5    NA19098        r1  A06 NA19098.r1 NA19098.r1.A06
6    NA19098        r1  A07 NA19098.r1 NA19098.r1.A07</code></pre>
<p>Input filtered molecule counts.</p>
<pre class="r"><code>molecules_filter &lt;- read.table(&quot;../data/molecules-filter.txt&quot;, header = TRUE,
                               stringsAsFactors = FALSE)
stopifnot(ncol(molecules_filter) == nrow(anno_filter),
          colnames(molecules_filter) == anno_filter$sample_id)</code></pre>
<p>Input standardized molecule counts.</p>
<pre class="r"><code>molecules_cpm &lt;- read.table(&quot;../data/molecules-cpm.txt&quot;, header = TRUE,
                            stringsAsFactors = FALSE)
stopifnot(ncol(molecules_cpm) == nrow(anno_filter),
          colnames(molecules_cpm) == anno_filter$sample_id)</code></pre>
<p>Input Poisson GLM transformed molecule counts per million.</p>
<pre class="r"><code>molecules_cpm_trans &lt;- read.table(&quot;../data/molecules-cpm-trans.txt&quot;, header = TRUE,
                               stringsAsFactors = FALSE)
stopifnot(ncol(molecules_cpm_trans) == nrow(anno_filter),
          colnames(molecules_cpm_trans) == anno_filter$sample_id)</code></pre>
<p>Input final batch-corrected molecule counts per million.</p>
<pre class="r"><code>molecules_final &lt;- read.table(&quot;../data/molecules-final.txt&quot;, header = TRUE,
                              stringsAsFactors = FALSE)
stopifnot(ncol(molecules_final) == nrow(anno_filter),
          colnames(molecules_final) == anno_filter$sample_id)</code></pre>
</div>
<div id="pca" class="section level2">
<h2>PCA</h2>
<div id="pca-of-filtered-data" class="section level3">
<h3>PCA of filtered data</h3>
<pre class="r"><code>pca_molecules_filter &lt;- run_pca(molecules_filter)
pca_molecules_filter_plot &lt;- plot_pca(pca_molecules_filter$PCs,
         explained = pca_molecules_filter$explained,
         metadata = anno_filter, color = &quot;individual&quot;,
         shape = &quot;replicate&quot;, alpha = 0.5, size = 2.2) +
  labs(title = &quot;Counts&quot;)</code></pre>
<pre class="r"><code>pca_molecules_filter_out &lt;- data.frame(Obs.id = 1:nrow(anno_filter),
                                       Obs.batch = anno_filter$batch,
                                       pca_molecules_filter$PCs[, 1:2])
write.table(pca_molecules_filter_out,
            file = &quot;../data/pca-molecules-filter.txt&quot;,
            quote = FALSE, sep = &quot;\t&quot;, row.names = FALSE)</code></pre>
<pre class="bash"><code>pca-distances -i ../data/pca-molecules-filter.txt</code></pre>
<pre><code>            NA19098.r3    NA19101.r1    NA19101.r2    NA19101.r3    NA19239.r1    NA19239.r2    NA19239.r3    
NA19098.r1  3.533561e+01  2.795329e+01  3.108176e+01  3.685457e+01  3.662411e+01  3.119577e+01  4.383286e+01
NA19098.r3                6.325114e+01  6.619283e+01  7.215802e+01  6.176294e+01  6.277506e+01  6.288494e+01
NA19101.r1                              7.570174e+00  8.906888e+00  3.210637e+01  1.794815e+01  4.380363e+01
NA19101.r2                                            9.531213e+00  3.967157e+01  2.543646e+01  5.137277e+01
NA19101.r3                                                          3.581286e+01  2.135155e+01  4.770952e+01
NA19239.r1                                                                        1.452473e+01  1.189914e+01
NA19239.r2                                                                                      2.641617e+01</code></pre>
<pre class="bash"><code>pca-dendrogram -i ../data/pca-molecules-filter.txt</code></pre>
<pre><code>                                                                                                                
                                                               +-----NA19101.r1                                 
                                        +----------------------|3.5e-03                                         
                                        |                      +-------NA19101.r3                               
 +--------------------------------------|0                                                                      
 |                                      |              +--------------------NA19098.r3                          
 |                                      |              |0                                                       
 |                                      +--------------|         +-------NA19098.r1                             
 |0                                                    +---------|6.9e-07                                       
 |                                                               +--------NA19101.r2                            
 |                                                                                                              
 |                                                           +--------------------------------------NA19239.r2  
 |                                                           |0                                                 
 +-----------------------------------------------------------|                 +-------------------NA19239.r1   
                                                             +-----------------|0                               
                                                                               +------------------NA19239.r3    
                                                                                                                </code></pre>
</div>
<div id="pca-of-standardized-data" class="section level3">
<h3>PCA of standardized data</h3>
<pre class="r"><code>pca_molecules_cpm &lt;- run_pca(molecules_cpm)
pca_molecules_cpm_plot &lt;- plot_pca(pca_molecules_cpm$PCs,
         explained = pca_molecules_cpm$explained,
         metadata = anno_filter, color = &quot;individual&quot;,
         shape = &quot;replicate&quot;, alpha = 0.5, size = 2.2) +
  labs(title = &quot;Counts per million (log)&quot;)</code></pre>
<pre class="r"><code>pca_molecules_cpm_out &lt;- data.frame(Obs.id = 1:nrow(anno_filter),
                                       Obs.batch = anno_filter$batch,
                                       pca_molecules_cpm$PCs[, 1:2])
write.table(pca_molecules_cpm_out,
            file = &quot;../data/pca-molecules-cpm.txt&quot;,
            quote = FALSE, sep = &quot;\t&quot;, row.names = FALSE)</code></pre>
<pre class="bash"><code>pca-distances -i ../data/pca-molecules-cpm.txt</code></pre>
<pre><code>            NA19098.r3    NA19101.r1    NA19101.r2    NA19101.r3    NA19239.r1    NA19239.r2    NA19239.r3    
NA19098.r1  2.283127e+01  1.934100e+01  5.296175e+01  2.764144e+01  4.969837e+01  3.699837e+01  4.594807e+01
NA19098.r3                5.978405e+00  3.026961e+01  8.082123e+00  3.866189e+01  2.588141e+01  4.246380e+01
NA19101.r1                              3.508682e+01  8.325224e+00  3.575672e+01  2.257645e+01  3.777460e+01
NA19101.r2                                            2.848375e+01  4.631674e+01  3.973253e+01  5.806423e+01
NA19101.r3                                                          3.087511e+01  1.850056e+01  3.614705e+01
NA19239.r1                                                                        1.323738e+01  1.539228e+01
NA19239.r2                                                                                      1.869540e+01</code></pre>
<pre class="bash"><code>pca-dendrogram -i ../data/pca-molecules-cpm.txt</code></pre>
<pre><code>                                                                                                               
                                                             +-------------------------------NA19239.r1        
 +-----------------------------------------------------------|0                                                
 |                                                           |                +-------------------NA19239.r2   
 |                                                           +----------------|0                               
 |0                                                                           +-----------------NA19239.r3     
 |                                                                                                             
 |                                      +--------------------------------------------------NA19098.r1          
 |                                      |0                                                                     
 +--------------------------------------|                 +----------------------------------------NA19101.r2  
                                        +-----------------|0                                                   
                                                          |                +-------------------NA19101.r3      
                                                          +----------------|0                                  
                                                                           |        +------NA19098.r3          
                                                                           +--------|7.2e-10                   
                                                                                    +-----NA19101.r1           
                                                                                                               </code></pre>
</div>
<div id="pca-of-poisson-glm-transformed-molecule-counts-per-million" class="section level3">
<h3>PCA of Poisson GLM transformed molecule counts per million</h3>
<pre class="r"><code>pca_molecules_cpm_trans &lt;- run_pca(molecules_cpm_trans)
pca_molecules_cpm_trans_plot &lt;- plot_pca(pca_molecules_cpm_trans$PCs,
         explained = pca_molecules_cpm_trans$explained,
         metadata = anno_filter, color = &quot;individual&quot;,
         shape = &quot;replicate&quot;,  alpha = 0.5, size = 2.2) +
  labs(title = &quot;Poisson transformation&quot;)</code></pre>
<pre class="r"><code>pca_molecules_cpm_trans_out &lt;- data.frame(Obs.id = 1:nrow(anno_filter),
                                       Obs.batch = anno_filter$batch,
                                       pca_molecules_cpm_trans$PCs[, 1:2])
write.table(pca_molecules_cpm_trans_out,
            file = &quot;../data/pca-molecules-cpm-trans.txt&quot;,
            quote = FALSE, sep = &quot;\t&quot;, row.names = FALSE)</code></pre>
<pre class="bash"><code>pca-distances -i ../data/pca-molecules-cpm-trans.txt</code></pre>
<pre><code>            NA19098.r3    NA19101.r1    NA19101.r2    NA19101.r3    NA19239.r1    NA19239.r2    NA19239.r3    
NA19098.r1  1.656283e+01  6.146432e+01  1.321773e+01  4.332598e+01  4.827787e+01  4.750276e+01  4.949364e+01
NA19098.r3                7.802604e+01  2.497308e+01  5.987233e+01  6.155863e+01  6.265747e+01  6.149072e+01
NA19101.r1                              5.731654e+01  1.845042e+01  4.202117e+01  2.987954e+01  4.863510e+01
NA19101.r2                                            4.062958e+01  5.399017e+01  5.019805e+01  5.661237e+01
NA19101.r3                                                          3.109027e+01  1.973393e+01  3.732732e+01
NA19239.r1                                                                        1.225009e+01  6.618308e+00
NA19239.r2                                                                                      1.885694e+01</code></pre>
<pre class="bash"><code>pca-dendrogram -i ../data/pca-molecules-cpm-trans.txt</code></pre>
<pre><code>                                                                                                          
                                                            +---------------------------------NA19239.r2  
                                                            |0                                            
 +----------------------------------------------------------|             +--------NA19239.r1             
 |                                                          +-------------|0                              
 |                                                                        +-------NA19239.r3              
 |0                                                                                                       
 |                                                                         +------NA19101.r1              
 |                                    +------------------------------------|0                             
 |                                    |                                    +-----------NA19101.r3         
 +------------------------------------|0                                                                  
                                      |                     +------------------NA19101.r2                 
                                      |                     |0                                            
                                      +---------------------|       +-----NA19098.r1                      
                                                            +-------|0                                    
                                                                    +---------NA19098.r3                  
                                                                                                          </code></pre>
</div>
<div id="pca-of-final-batch-corrected-data" class="section level3">
<h3>PCA of final batch-corrected data</h3>
<pre class="r"><code>pca_final &lt;- run_pca(molecules_final)
pca_final_plot &lt;- plot_pca(pca_final$PCs, explained = pca_final$explained,
         metadata = anno_filter, color = &quot;individual&quot;,
         shape = &quot;replicate&quot;, alpha = 0.5, size = 2.2) +
  labs(title = &quot;Batch corrected&quot;)</code></pre>
<pre class="r"><code>pca_final_out &lt;- data.frame(Obs.id = 1:nrow(anno_filter),
                            Obs.batch = anno_filter$batch,
                            pca_final$PCs[, 1:2])
write.table(pca_final_out,
            file = &quot;../data/pca-final.txt&quot;,
            quote = FALSE, sep = &quot;\t&quot;, row.names = FALSE)</code></pre>
<pre class="bash"><code>pca-distances -i ../data/pca-final.txt</code></pre>
<pre><code>            NA19098.r3    NA19101.r1    NA19101.r2    NA19101.r3    NA19239.r1    NA19239.r2    NA19239.r3    
NA19098.r1  5.080952e+00  5.435574e+01  3.835040e+01  4.975047e+01  5.613992e+01  5.478609e+01  5.546367e+01
NA19098.r3                5.926557e+01  4.294858e+01  5.468422e+01  6.085990e+01  5.961170e+01  6.014592e+01
NA19101.r1                              1.830388e+01  4.708103e+00  3.624496e+01  3.249704e+01  3.706498e+01
NA19101.r2                                            1.472089e+01  4.267492e+01  3.927972e+01  4.297114e+01
NA19101.r3                                                          3.429283e+01  3.056554e+01  3.498175e+01
NA19239.r1                                                                        3.748794e+00  1.333070e+00
NA19239.r2                                                                                      4.658342e+00</code></pre>
<pre class="bash"><code>pca-dendrogram -i ../data/pca-final.txt</code></pre>
<pre><code>                                                                                                    
                                                             +------------NA19239.r2                
                                                             |2.4e-08                               
 +-----------------------------------------------------------|       +-----NA19239.r1               
 |                                                           +-------|0.32                          
 |                                                                   +-----NA19239.r3               
 |0                                                                                                 
 |                                                                             +------NA19098.r1    
 |                                       +-------------------------------------|0.02                
 |                                       |                                     +-------NA19098.r3   
 +---------------------------------------|0                                                         
                                         |                           +--------------NA19101.r2      
                                         |                           |4.3e-11                       
                                         +---------------------------|         +------NA19101.r1    
                                                                     +---------|7.7e-03             
                                                                               +--------NA19101.r3  
                                                                                                    </code></pre>
</div>
</div>
<div id="data-transformation-figure" class="section level2">
<h2>Data transformation figure</h2>
<pre class="r"><code>plot_grid(pca_molecules_filter_plot + theme(legend.position = &quot;none&quot;),
          pca_molecules_cpm_plot + theme(legend.position = &quot;none&quot;),
          pca_molecules_cpm_trans_plot + theme(legend.position = &quot;none&quot;),
          pca_final_plot + theme(legend.position = &quot;none&quot;),
          labels = LETTERS[1:4])</code></pre>
<p><img src="figure/data-transformation.Rmd/data-transformation-1.png" title="" alt="" width="1152" style="display: block; margin: auto;" /></p>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.2.0 (2015-04-16)
Platform: x86_64-unknown-linux-gnu (64-bit)

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] testit_0.4    cowplot_0.3.1 ggplot2_1.0.1 knitr_1.10.5 

loaded via a namespace (and not attached):
 [1] Rcpp_0.12.0      magrittr_1.5     MASS_7.3-40      munsell_0.4.2   
 [5] colorspace_1.2-6 stringr_1.0.0    httr_0.6.1       plyr_1.8.3      
 [9] tools_3.2.0      grid_3.2.0       gtable_0.1.2     htmltools_0.2.6 
[13] yaml_2.1.13      digest_0.6.8     reshape2_1.4.1   formatR_1.2     
[17] bitops_1.0-6     RCurl_1.95-4.6   evaluate_0.7     rmarkdown_0.6.1 
[21] labeling_0.3     stringi_0.4-1    scales_0.2.4     proto_0.3-10    </code></pre>
</div>


<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>

<script>

// manage active state of menu based on current page
$(document).ready(function () {

    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');

    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');

});

</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
