<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="date" content="2015-09-09" />

<title>Mixed effect model for batch correction</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">

/* padding for bootstrap navbar */
body {
  padding-top: 50px;
  padding-bottom: 40px;
}


/* offset scroll position for anchor links (for fixed navbar)  */
.section h2 {
  padding-top: 55px;
  margin-top: -55px;
}
.section h3 {
  padding-top: 55px;
  margin-top: -55px;
}



/* don't use link color in navbar */
.dropdown-menu>li>a {
  color: black;
}

/* some padding for disqus */
#disqus_thread {
  margin-top: 45px;
}

</style>

<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/textmate.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">


<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">singleCellSeq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="license.html">License</a></li>
        <li><a href="https://github.com/jdblischak/singleCellSeq">GitHub</a></li>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">
<h1 class="title">Mixed effect model for batch correction</h1>
<h4 class="date"><em>2015-09-09</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#input">Input</a></li>
<li><a href="#mixed-model-for-batch-effect-correction">Mixed model for batch-effect correction</a><ul>
<li><a href="#crossed-model">Crossed Model</a></li>
<li><a href="#remove-unwanted-variation">Remove unwanted variation</a></li>
</ul></li>
<li><a href="#pca">PCA</a></li>
<li><a href="#session-information">Session information</a></li>
</ul>
</div>

<p><strong>Last updated:</strong> 2016-01-26</p>
<p><strong>Code version:</strong> a6478d5228e9af6afb1f1b70e4ef8e1730a6d9ba</p>
<pre class="r"><code>library(&quot;limma&quot;)
library(&quot;edgeR&quot;)
library(&quot;ggplot2&quot;)
theme_set(theme_bw(base_size = 12))
source(&quot;functions.R&quot;)
library(&quot;Humanzee&quot;)</code></pre>
<p>This file uses a mixed effects model to remove technical batch effects. The modeling function is adapted from the package <a href="http://www.bioconductor.org/packages/release/bioc/html/limma.html">limma</a> and is implemented in the package <a href="https://github.com/jhsiao999/Humanzee">Humanzee</a>.</p>
<p>Creates the following file:</p>
<p><strong><a href="https://github.com/jdblischak/singleCellSeq/blob/master/data/molecules-final.txt">molecules-final.txt</a></strong> - Molecules in high quality single cells after removing unwanted variation with mixed model</p>
<div id="input" class="section level2">
<h2>Input</h2>
<p>Input filtered annotation.</p>
<pre class="r"><code>anno_filter &lt;- read.table(&quot;../data/annotation-filter.txt&quot;, header = TRUE,
                   stringsAsFactors = FALSE)
head(anno_filter)</code></pre>
<pre><code>  individual replicate well      batch      sample_id
1    NA19098        r1  A01 NA19098.r1 NA19098.r1.A01
2    NA19098        r1  A02 NA19098.r1 NA19098.r1.A02
3    NA19098        r1  A04 NA19098.r1 NA19098.r1.A04
4    NA19098        r1  A05 NA19098.r1 NA19098.r1.A05
5    NA19098        r1  A06 NA19098.r1 NA19098.r1.A06
6    NA19098        r1  A07 NA19098.r1 NA19098.r1.A07</code></pre>
<p>Input Poisson GLM transformed molecule counts per million.</p>
<pre class="r"><code>molecules_cpm_trans &lt;- read.table(&quot;../data/molecules-cpm-trans.txt&quot;, header = TRUE,
                               stringsAsFactors = FALSE)
stopifnot(ncol(molecules_cpm_trans) == nrow(anno_filter),
          colnames(molecules_cpm_trans) == anno_filter$sample_id)</code></pre>
</div>
<div id="mixed-model-for-batch-effect-correction" class="section level2">
<h2>Mixed model for batch-effect correction</h2>
<p>Because the <a href="poison-glm-normalization.html">Poisson transformation with the ERCC controls</a> was not sufficient to remove all the unwanted technical variation, we used a mixed model to correct for batch effects.</p>
<p>We adapted limma’s algorithm for estimating variance components due to random effects. This analysis operates under the assumption that biological replicates (or batches within an individual in this case) share similar correlation across genes. Morever, the analysis permits negative correlation between replicates.</p>
<div id="crossed-model" class="section level3">
<h3>Crossed Model</h3>
<p>For every single gene, we will fit a mixed model assuming differences between batches are not individual-specific as follows</p>
<p><span class="math">\[ y_{ijk} = \mu + \alpha_i + b_j + \epsilon_{ijk} \]</span>,</p>
<p>where <span class="math">\(y_{ijk}\)</span> is the log2 counts-per-million (cpm) for any gene in individual <span class="math">\(i\)</span>, batch <span class="math">\(j\)</span>, and cell <span class="math">\(k\)</span>, <span class="math">\(\mu\)</span> is the gene-specific expression level across all cells, <span class="math">\(\alpha_i\)</span> is the expression level specific to individual <span class="math">\(i\)</span>, <span class="math">\(b_j\)</span> is batch <span class="math">\(j\)</span>‘s deviation of expression level from gene-specific expression levels, and <span class="math">\(\epsilon_{ijk}\)</span> is the models’ residual error.</p>
<p>We assume that <span class="math">\(b_j\)</span> follows a normal distribution with <span class="math">\(b_j \sim N(0, \sigma^2_b)\)</span> for <span class="math">\(j = 1, \dots, 9\)</span>, and <span class="math">\(\epsilon_{ijk} \sim N(0, \sigma^2_\epsilon)\)</span> for <span class="math">\(i = 1, 2, 3; j = 1, \dots, 9; and k = 1, \dots, n_{ij}\)</span>, where <span class="math">\(n_ij\)</span> denotes the number of cells in individual <span class="math">\(i\)</span>, batch <span class="math">\(j\)</span>.</p>
</div>
<div id="remove-unwanted-variation" class="section level3">
<h3>Remove unwanted variation</h3>
<p>Create design matrix and compute a consensus correlation coefficient using limma’s duplicateCorrelation function.</p>
<pre class="r"><code>block &lt;- anno_filter$batch
design &lt;- model.matrix(~ 1 + individual, data = anno_filter)</code></pre>
<pre class="r"><code>dup_corrs &lt;- duplicateCorrelation(molecules_cpm_trans, design = design,
                                  block = block)</code></pre>
<p>Fit a mixed model with the 9 batches being the random effect.</p>
<pre class="r"><code>gls_fit &lt;- Humanzee::ruv_mixed_model(molecules_cpm_trans,
                                     ndups = 1,
                                     design = design,
                                     block = block,
                                     correlation = dup_corrs$cons)</code></pre>
<p>Compute expression levels after removing variation due to random effects.</p>
<pre class="r"><code>molecules_final &lt;- t( design %*% t(gls_fit$coef) ) + gls_fit$resid</code></pre>
<p>Output the cleaned data.</p>
<pre class="r"><code>colnames(molecules_final) &lt;- colnames(molecules_cpm_trans)
write.table(round(molecules_final, digits = 6), &quot;../data/molecules-final.txt&quot;, quote = FALSE,
            sep = &quot;\t&quot;, col.names = NA)</code></pre>
</div>
</div>
<div id="pca" class="section level2">
<h2>PCA</h2>
<pre class="r"><code>pca_final &lt;- run_pca(molecules_final)
pca_final_plot &lt;- plot_pca(pca_final$PCs, explained = pca_final$explained,
         metadata = anno_filter, color = &quot;individual&quot;,
         shape = &quot;replicate&quot;) +
  labs(title = &quot;Batch corrected&quot;)
pca_final_plot</code></pre>
<p><img src="figure/batch-correction.Rmd/pca-molecules-final-1.png" title="" alt="" width="768" style="display: block; margin: auto;" /></p>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.2.0 (2015-04-16)
Platform: x86_64-unknown-linux-gnu (64-bit)

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] testit_0.4     Humanzee_0.1.0 ggplot2_1.0.1  edgeR_3.10.2  
[5] limma_3.24.9   knitr_1.10.5  

loaded via a namespace (and not attached):
 [1] Rcpp_0.12.0      magrittr_1.5     MASS_7.3-40      munsell_0.4.2   
 [5] colorspace_1.2-6 stringr_1.0.0    httr_0.6.1       plyr_1.8.3      
 [9] tools_3.2.0      grid_3.2.0       gtable_0.1.2     htmltools_0.2.6 
[13] yaml_2.1.13      digest_0.6.8     reshape2_1.4.1   formatR_1.2     
[17] bitops_1.0-6     RCurl_1.95-4.6   evaluate_0.7     rmarkdown_0.6.1 
[21] labeling_0.3     stringi_0.4-1    scales_0.2.4     proto_0.3-10    </code></pre>
</div>


<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>

<script>

// manage active state of menu based on current page
$(document).ready(function () {

    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');

    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');

});

</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
