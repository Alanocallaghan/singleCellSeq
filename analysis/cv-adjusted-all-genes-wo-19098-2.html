<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Joyce Hsiao" />

<meta name="date" content="2015-10-16" />

<title>Compare Coefficient of variation between individuals</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">

/* padding for bootstrap navbar */
body {
  padding-top: 50px;
  padding-bottom: 40px;
}


/* offset scroll position for anchor links (for fixed navbar)  */
.section h2 {
  padding-top: 55px;
  margin-top: -55px;
}
.section h3 {
  padding-top: 55px;
  margin-top: -55px;
}



/* don't use link color in navbar */
.dropdown-menu>li>a {
  color: black;
}

/* some padding for disqus */
#disqus_thread {
  margin-top: 45px;
}

</style>

<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/textmate.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">


<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">singleCellSeq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="license.html">License</a></li>
        <li><a href="https://github.com/jdblischak/singleCellSeq">GitHub</a></li>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">
<h1 class="title">Compare Coefficient of variation between individuals</h1>
<h4 class="author"><em>Joyce Hsiao</em></h4>
<h4 class="date"><em>2015-10-16</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#objective">Objective</a></li>
<li><a href="#set-up">Set up</a></li>
<li><a href="#prepare-data">Prepare data</a></li>
<li><a href="#normalize-coefficient-of-variation">Normalize coefficient of variation</a></li>
<li><a href="#limma">limma</a></li>
<li><a href="#p-value-and-sparsity">P-value and sparsity</a></li>
<li><a href="#cpm-density-distributions-of-significant-genes">CPM density distributions of significant genes</a></li>
<li><a href="#session-information">Session information</a></li>
</ul>
</div>

<p><strong>Last updated:</strong> 2015-12-11</p>
<p><strong>Code version:</strong> 884b335605607bd2cf5c9a1ada1e345466388866</p>
<div id="objective" class="section level2">
<h2>Objective</h2>
<p>Previously, we used the entire set of data including all individuals and all batches to perform normalization of coefficient of variations (<a href="http://jdblischak.github.io/singleCellSeq/analysis/cv-adjusted.html">link1</a>) and performed</p>
<p>In this document, we wil perform per gene differential analysis of coefficients of variations using only coefficients of variation from ENSG genes and also from QC-approved batches (no NA19098.r2).</p>
</div>
<div id="set-up" class="section level2">
<h2>Set up</h2>
<pre class="r"><code>library(&quot;data.table&quot;)
library(&quot;dplyr&quot;)
library(&quot;limma&quot;)
library(&quot;edgeR&quot;)
library(&quot;ggplot2&quot;)
library(&quot;grid&quot;)
library(&quot;zoo&quot;)
theme_set(theme_bw(base_size = 12))
source(&quot;functions.R&quot;)</code></pre>
</div>
<div id="prepare-data" class="section level2">
<h2>Prepare data</h2>
<p>Input annotation of only QC-filtered single cells</p>
<pre class="r"><code>anno_qc &lt;- read.table(&quot;../data/annotation-filter.txt&quot;, header = TRUE,
                   stringsAsFactors = FALSE)
head(anno_qc)</code></pre>
<pre><code>  individual replicate well      batch      sample_id
1    NA19098        r1  A01 NA19098.r1 NA19098.r1.A01
2    NA19098        r1  A02 NA19098.r1 NA19098.r1.A02
3    NA19098        r1  A04 NA19098.r1 NA19098.r1.A04
4    NA19098        r1  A05 NA19098.r1 NA19098.r1.A05
5    NA19098        r1  A06 NA19098.r1 NA19098.r1.A06
6    NA19098        r1  A07 NA19098.r1 NA19098.r1.A07</code></pre>
<p>Remove NA19098.r2</p>
<pre class="r"><code>is_include &lt;- anno_qc$batch != &quot;NA19098.r2&quot;
anno_qc_filter &lt;- anno_qc[which(is_include), ]</code></pre>
<p>Import endogeneous gene molecule counts that are QC-filtered, CPM-normalized, ERCC-normalized, and also processed to remove unwanted variation from batch effet. ERCC genes are removed from this file.</p>
<pre class="r"><code>molecules_ENSG &lt;- read.table(&quot;../data/molecules-final.txt&quot;, header = TRUE, stringsAsFactors = FALSE)
molecules_ENSG &lt;- molecules_ENSG[ , is_include]</code></pre>
<p>Input moleclule counts before log2 CPM transformation. This file is used to compute percent zero-count cells per sample.</p>
<pre class="r"><code>molecules_sparse &lt;- read.table(&quot;../data/molecules-filter.txt&quot;, header = TRUE, stringsAsFactors = FALSE)

molecules_sparse &lt;- molecules_sparse[grep(&quot;ENSG&quot;, rownames(molecules_sparse)), ]
stopifnot( all.equal(rownames(molecules_ENSG), rownames(molecules_sparse)) )</code></pre>
</div>
<div id="normalize-coefficient-of-variation" class="section level2">
<h2>Normalize coefficient of variation</h2>
<p>Compute coefficient of variation.</p>
<pre class="r"><code># Compute CV and mean of normalized molecule counts (take 2^(log2-normalized count))

molecules_cv_batch_ENSG &lt;- 
  lapply(1:length(unique(anno_qc_filter$batch)), function(per_batch) {
      molecules_per_batch &lt;- 2^molecules_ENSG[ , unique(anno_qc_filter$batch) == unique(anno_qc_filter$batch)[per_batch] ]
      mean_per_gene &lt;- apply(molecules_per_batch, 1, mean, na.rm = TRUE)
      sd_per_gene &lt;- apply(molecules_per_batch, 1, sd, na.rm = TRUE)
      cv_per_gene &lt;- data.frame(mean = mean_per_gene,
                                sd = sd_per_gene,
                                cv = sd_per_gene/mean_per_gene)
      rownames(cv_per_gene) &lt;- rownames(molecules_ENSG)
  
      # cv_per_gene &lt;- cv_per_gene[rowSums(is.na(cv_per_gene)) == 0, ]
      cv_per_gene$batch &lt;- unique(anno_qc_filter$batch)[per_batch]
      
      # Add sparsity percent
      molecules_sparse_per_batch &lt;- molecules_sparse[ , unique(anno_qc_filter$batch) == unique(anno_qc_filter$batch)[per_batch]]
      cv_per_gene$sparse &lt;- rowMeans(as.matrix(molecules_sparse_per_batch) == 0)
        
      return(cv_per_gene)
      }) 
names(molecules_cv_batch_ENSG) &lt;- unique(anno_qc_filter$batch)

sapply(molecules_cv_batch_ENSG, dim)</code></pre>
<pre><code>     NA19098.r1 NA19098.r3 NA19101.r1 NA19101.r2 NA19101.r3 NA19239.r1
[1,]      10564      10564      10564      10564      10564      10564
[2,]          5          5          5          5          5          5
     NA19239.r2 NA19239.r3
[1,]      10564      10564
[2,]          5          5</code></pre>
<p>Merge summary data.frames.</p>
<pre class="r"><code>df_ENSG &lt;- do.call(rbind, molecules_cv_batch_ENSG)</code></pre>
<p>Compute rolling medians across all samples.</p>
<pre class="r"><code># Compute a data-wide coefficient of variation on CPM normalized counts.
data_cv_ENSG &lt;- apply(2^molecules_ENSG, 1, sd)/apply(2^molecules_ENSG, 1, mean)

# Order of genes by mean expression levels
order_gene &lt;- order(apply(2^molecules_ENSG, 1, mean))

# Rolling medians of log10 squared CV by mean expression levels
roll_medians &lt;- rollapply(log10(data_cv_ENSG^2)[order_gene], width = 50, by = 25,
                         FUN = median, fill = list(&quot;extend&quot;, &quot;extend&quot;, &quot;NA&quot;) )
ii_na &lt;- which( is.na(roll_medians) )
roll_medians[ii_na] &lt;- median( log10(data_cv_ENSG^2)[order_gene][ii_na] )

names(roll_medians) &lt;- rownames(molecules_ENSG)[order_gene]


# re-order rolling medians
reorder_gene &lt;- match(rownames(molecules_ENSG), names(roll_medians) )
roll_medians &lt;- roll_medians[ reorder_gene ]

stopifnot( all.equal(names(roll_medians), rownames(molecules_ENSG) ) )</code></pre>
<p>Compute adjusted coefficient of variation.</p>
<pre class="r"><code># adjusted coefficient of variation on log10 scale
log10cv2_adj_ENSG &lt;- 
  lapply(1:length(molecules_cv_batch_ENSG), function(per_batch) {
    foo &lt;- log10(molecules_cv_batch_ENSG[[per_batch]]$cv^2) - roll_medians
    return(foo)
})
df_ENSG$log10cv2_adj_ENSG &lt;- do.call(c, log10cv2_adj_ENSG)</code></pre>
</div>
<div id="limma" class="section level2">
<h2>limma</h2>
<p>We use the <em>lmFit</em> function in the limma package to fit linear models comparing coefficients of variations between individuals for all genes. <em>lmFit</em> provides a fast algorithm for least-square estimation, when design matrix is the same for all genes.</p>
<pre class="r"><code>library(limma)

df_limma &lt;- matrix(df_ENSG$log10cv2_adj_ENSG, 
                      nrow = nrow(molecules_ENSG), ncol = 8, byrow = FALSE)

design &lt;- data.frame(individual = factor(rep(unique(anno_qc_filter$individual), each = 3) ),
                     rep = factor(rep(c(1:3), times = 3)) )
design &lt;- design[ with(design, !(individual == &quot;NA19098&quot; &amp; rep == &quot;2&quot;)), ]

colnames(df_limma) &lt;- with(design, paste0(individual, rep))

fit_limma &lt;- lmFit(df_limma, design = model.matrix( ~ individual, data = design))                      
fit_limma &lt;- eBayes(fit_limma)</code></pre>
<p>Voom plot of all genes</p>
<pre class="r"><code>voom(10^df_limma, design = model.matrix(~individual, data = design),
     plot = TRUE)</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-11-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<pre><code>An object of class &quot;EList&quot;
$E
     NA190981 NA190983 NA191011 NA191012 NA191013 NA192391 NA192392
[1,] 6.667693 7.744440 7.177290 6.473759 6.768223 7.195293 7.179695
[2,] 6.789123 6.673820 6.865137 7.371818 7.297338 7.050406 7.293339
[3,] 7.087622 7.305000 7.291008 7.291007 7.060775 7.128955 7.054246
[4,] 6.814275 6.953216 6.791595 6.683958 6.650781 7.190253 6.694229
[5,] 6.548134 6.853805 6.959224 6.833469 6.959080 6.990432 6.985725
     NA192393
[1,] 7.155782
[2,] 6.936526
[3,] 7.397030
[4,] 6.654184
[5,] 6.864486
10559 more rows ...

$weights
         [,1]     [,2]     [,3]     [,4]     [,5]     [,6]     [,7]
[1,] 21.19654 27.72352 36.54855 36.64173 36.81388 26.20812 28.69949
[2,] 30.72420 43.71464 25.91773 26.01468 26.19418 28.87147 30.03071
[3,] 21.17937 28.01805 24.58450 24.65286 24.77921 25.47428 28.39366
[4,] 28.01208 36.17196 41.18261 41.29711 41.50874 35.11042 38.24292
[5,] 31.38078 45.54575 32.25810 32.33482 32.47651 31.48786 34.02597
         [,8]
[1,] 26.23264
[2,] 28.88002
[3,] 25.49795
[4,] 35.13233
[5,] 31.50386
10559 more rows ...

$design
  (Intercept) individualNA19101 individualNA19239
1           1                 0                 0
3           1                 0                 0
4           1                 1                 0
5           1                 1                 0
6           1                 1                 0
7           1                 0                 1
8           1                 0                 1
9           1                 0                 1
attr(,&quot;assign&quot;)
[1] 0 1 1
attr(,&quot;contrasts&quot;)
attr(,&quot;contrasts&quot;)$individual
[1] &quot;contr.treatment&quot;


$targets
          lib.size
NA190981 12460.437
NA190983 10031.687
NA191011 10519.534
NA191012 10503.758
NA191013 10474.806
NA192391 10481.101
NA192392  9966.833
NA192393 10477.171</code></pre>
<p>limma unmoderated F-test p-value</p>
<pre class="r"><code>hist(fit_limma$F.p.value, breaks = 100, main = &quot;F-test p-value&quot;)</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-12-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<p>False discover control adjutment.</p>
<pre class="r"><code>F.p.adj &lt;- p.adjust(fit_limma$F.p.value, method = &quot;fdr&quot;)
summary(F.p.adj)</code></pre>
<pre><code>   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
 0.0000  0.4781  0.7170  0.6528  0.8836  0.9996 </code></pre>
<pre class="r"><code>hist(F.p.adj, main = &quot;False discovery rate&quot;, xlab = &quot;FDR&quot;)</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-13-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<p>Cutoffs</p>
<pre class="r"><code>df_cuts &lt;- data.frame(cuts = c(.001, .01, .05, .1, .15, .2))
df_cuts$sig_count &lt;- sapply(1:6, function(per_cut) {
                    sum(F.p.adj &lt; df_cuts$cuts[per_cut] )
                    })
df_cuts</code></pre>
<pre><code>   cuts sig_count
1 0.001        91
2 0.010       192
3 0.050       385
4 0.100       560
5 0.150       780
6 0.200      1004</code></pre>
<p>P-value before versus after false discovery adjustment.</p>
<pre class="r"><code>plot(y = F.p.adj, x = fit_limma$F.p.value,
     xlab = &quot;F-test p-value&quot;, ylab = &quot;FDR&quot;)</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-15-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="p-value-and-sparsity" class="section level2">
<h2>P-value and sparsity</h2>
<pre class="r"><code>df_sparse &lt;- rowMeans(matrix(df_ENSG$sparse, nrow = nrow(molecules_ENSG), ncol = 8,
                      byrow = FALSE) )

plot(x = df_sparse, y = log10(fit_limma$F.p.value),
     xlab = &quot;Average percent of zero-count cells&quot;,
     ylab = &quot;log10(p-value of F-test)&quot;,
     main = &quot;CV and sparsity of all genes&quot;, col = &quot;grey60&quot;)</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-16-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<p>Correlation between mean sparsity rate and p-value.</p>
<pre class="r"><code>cor(df_sparse, fit_limma$F.p.value, method = &quot;spearman&quot;)</code></pre>
<pre><code>[1] -0.1791479</code></pre>
</div>
<div id="cpm-density-distributions-of-significant-genes" class="section level2">
<h2>CPM density distributions of significant genes</h2>
<p>Rank genes by FDR.</p>
<pre class="r"><code>order_limma &lt;- order(F.p.adj)

ggplot(data.frame(values = unlist(molecules_ENSG[order_limma[1],] ),
                  individual = factor(anno_qc_filter$individual),
                  replicate = factor(anno_qc_filter$replicate),
                  batch = factor(anno_qc_filter$batch), check.rows = F)
       , aes(x = values)) + 
  geom_density(aes(group = batch, col = individual)) +
  ggtitle(paste(&quot;The most significant gene&quot;, rownames(molecules_ENSG)[order_limma[1]]) )</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-18-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data.frame(values = unlist(molecules_ENSG[order_limma[2],] ),
                  individual = factor(anno_qc_filter$individual),
                  replicate = factor(anno_qc_filter$replicate),
                  batch = factor(anno_qc_filter$batch), check.rows = F), aes(x = values)) + 
  geom_density(aes(group = batch, col = individual)) +
  ggtitle(paste(&quot;The second significant gene&quot;, rownames(molecules_ENSG)[order_limma[2]]) )</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-18-2.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggplot(data.frame(values = unlist(molecules_ENSG[order_limma[3],] ),
                  individual = factor(anno_qc_filter$individual),
                  replicate = factor(anno_qc_filter$replicate),
                  batch = factor(anno_qc_filter$batch), check.rows = F), aes(x = values)) + 
  geom_density(aes(group = batch, col = individual)) +
  ggtitle(paste(&quot;The third significant gene&quot;, rownames(molecules_ENSG)[order_limma[3]]) )</code></pre>
<p><img src="figure/cv-adjusted-all-genes-wo-19098-2.Rmd/unnamed-chunk-18-3.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.2.1 (2015-06-18)
Platform: x86_64-apple-darwin13.4.0 (64-bit)
Running under: OS X 10.10.5 (Yosemite)

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
[1] zoo_1.7-12       ggplot2_1.0.1    edgeR_3.10.5     limma_3.24.15   
[5] dplyr_0.4.3      data.table_1.9.6 knitr_1.11      

loaded via a namespace (and not attached):
 [1] Rcpp_0.12.2      magrittr_1.5     MASS_7.3-45      munsell_0.4.2   
 [5] lattice_0.20-33  colorspace_1.2-6 R6_2.1.1         stringr_1.0.0   
 [9] plyr_1.8.3       tools_3.2.1      parallel_3.2.1   gtable_0.1.2    
[13] DBI_0.3.1        htmltools_0.2.6  yaml_2.1.13      assertthat_0.1  
[17] digest_0.6.8     reshape2_1.4.1   formatR_1.2.1    evaluate_0.8    
[21] rmarkdown_0.8.1  labeling_0.3     stringi_1.0-1    scales_0.3.0    
[25] chron_2.3-47     proto_0.3-10    </code></pre>
</div>


<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>

<script>

// manage active state of menu based on current page
$(document).ready(function () {

    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');

    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');

});

</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
