---
title: "Coefficient of variation: back to the basics"
author: "Joyce Hsiao"
date: 2015-09-27
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r chunk-options, include=FALSE}
source("chunk-options.R")
```


## Objectives


## Set up

```{r}
library(ggplot2)
library(edgeR)
library(limma)
```


## Prepare data

Input annotation

```{r}
anno <- read.table("../data/annotation.txt", header = TRUE,
                   stringsAsFactors = FALSE)
head(anno)
```


Input molecule counts

```{r}
molecules <- read.table("../data/molecules.txt", header = TRUE, stringsAsFactors = FALSE)
```

Remove bulk samples

```{r}
single_samples <- anno$well != "bulk"
anno_single <- anno[ which(single_samples), ]
molecules_single <- molecules[ , which(single_samples)]
stopifnot(ncol(molecules_single) == nrow(anno_single),
          colnames(molecules_single) == anno_single$sample_id)
```

Remove ERCC genes.

```{r}
nonERCC <- grep("ERCC", rownames(molecules_single), invert = TRUE)
molecules_single <- molecules_single[nonERCC, ]
```


Remove genes with no counts and also overly expressed genes.

```{r}
## remove gene with 0 counts
expressed_single <- rowSums(molecules_single) > 0
molecules_single <- molecules_single[expressed_single, ]
dim(molecules_single)

## remove gene with molecule count larger than 1024 (15 if them)
overexpressed_genes <- rownames(molecules_single)[apply(molecules_single, 1,
                                                        function(x) any(x >= 1024))]
molecules_single <- molecules_single[!(rownames(molecules_single) %in% overexpressed_genes), ]

## collision probability and cpm molecule counts
molecules_single_collision <- -1024 * log(1 - molecules_single / 1024)
molecules_single_cpm <- cpm(molecules_single_collision, log = TRUE)
```



## Compute coefficient of variation

Compute per batch coefficient of variation.

```{r}
unique_batch <- with(anno_single, paste(individual, batch, sep = "_"))

molecules_cv_batch <- 
  lapply(1:length(unique(unique_batch)), function(per_batch) {
    molecules_per_batch <- molecules_single_collision[ , unique_batch == unique(unique_batch)[per_batch]]
    cv_foo <- data.frame(mean = apply(molecules_per_batch, 1, mean, na.rm = TRUE),
           cv = apply(molecules_per_batch, 1, sd, na.rm = TRUE) / 
                apply(molecules_per_batch, 1, mean, na.rm = TRUE) )
    rownames(cv_foo) <- rownames(molecules_single_collision)
    
    cv_foo <- cv_foo[rowSums(is.na(cv_foo)) == 0, ]
    cv_foo$batch <- unique(unique_batch)[per_batch]
      
    return(cv_foo)
    }) 
names(molecules_cv_batch) <- unique(unique_batch)
```


Subset CV data to include only genes that have data across all batches.

```{r}
all_genes <- lapply(1:3, function(ii) {
                intersect(intersect(rownames(molecules_cv_batch[[ 1+ (ii-1)*3]]),
                                    rownames(molecules_cv_batch[[ 2+ (ii-1)*3]]) ),
                          rownames(molecules_cv_batch[[3 + (ii-1)*3]]) ) })
all_genes <- intersect(intersect(all_genes[[1]], all_genes[[2]]), all_genes[[3]])
str(all_genes)

molecules_cv_batch <- 
  lapply(1: length(molecules_cv_batch), function(per_batch) {
          ii_include <- which(rownames(molecules_cv_batch[[per_batch]]) %in% all_genes)
          molecules_cv_batch[[per_batch]][ ii_include, ]
  })

stopifnot(all.equal(rownames(molecules_cv_batch[[9]]), rownames(molecules_cv_batch[[8]]) ) )

nrow(molecules_cv_batch[[1]])
```


## CV-mean dependency mean

```{r}
unique_batch <- with(anno_single, paste(individual, batch, sep = "_"))

fit_lowess <- approxfun(lowess(molecules_cv_batch[[1]]$cv, molecules_cv_batch[[1]]$mean) )

ii_batch <- unique_batch %in% unique(unique_batch)[1]

df_batch <- molecules_single_collision[ , ii_batch]
ww <- 1/fit_lowess(as.matrix(df_batch) )
dim(ww) <- dim(df_batch)

df_batch_ww <- t(t(df_batch)*ww)

df_batch_cv <- data.frame(mean = apply(df_batch_ww, 1, mean),
                          cv = apply(df_batch_ww, 1, sd)/apply(df_batch_ww, 1, mean) )


```



## Session information

```{r info}
sessionInfo()
```
