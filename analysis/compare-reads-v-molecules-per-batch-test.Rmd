---
title: "Batch effects of conversion rates"
date: 2015-10-23
author: Joyce Hsiao
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r chunk-options, include=FALSE}
source("chunk-options.R")
# opts_chunk$set(cache = TRUE)
```


## Objective

Compute conversion rates of each cell using the filerted set of cells. Compare conversion rates between batches: is there an individual effect or batch effect of coversion rate?

Note that we will remove the NA19098 batch 2 in the following analyses. 

We will use analysis of variance to test whether conversion rates are significantly different between individuals. Results below are described at an alpha level of .05.




## Input

```{r packages, message=FALSE}
library("dplyr")
library("ggplot2")
theme_set(theme_bw(base_size = 16))
library("edgeR")
source("functions.R")
```

Input annotation.

```{r input-annotation}
anno_filter <- read.table("../data/annotation-filter.txt", header = TRUE,
                   stringsAsFactors = FALSE)
select_individual <- anno_filter$batch != "NA19098.r2"
anno_filter <- anno_filter[select_individual, ]
head(anno_filter)
```

Input read counts.

```{r input-read-counts}
reads_filter <- read.table("../data/reads-filter.txt", header = TRUE,
                    stringsAsFactors = FALSE)
reads_filter <- reads_filter[ , select_individual]
reads_ENSG <- reads_filter[grep("ERCC", rownames(reads_filter), invert = TRUE), ]
reads_ERCC <- reads_filter[grep("ERCC", rownames(reads_filter), invert = FALSE), ]
```

Input molecule counts.

```{r input-molecule-counts}
molecules_filter <- read.table("../data/molecules-filter.txt", header = TRUE,
                    stringsAsFactors = FALSE)
molecules_filter <- molecules_filter[ , select_individual]
molecules_ENSG <- molecules_filter[grep("ERCC", rownames(molecules_filter), invert = TRUE), ]
molecules_ERCC <- molecules_filter[grep("ERCC", rownames(molecules_filter), invert = FALSE), ]
```

## Reads to molecule conversion rate

```{r conversion-rate}
total_counts_ERCC <- data.frame(total_reads = colSums(reads_ERCC),
                                total_molecules = colSums(molecules_ERCC))
total_counts_ERCC$conversion <- with(total_counts_ERCC,
                                     total_reads/total_molecules)
summary(total_counts_ERCC)


total_counts_ENSG <- data.frame(total_reads = colSums(reads_ENSG),
                                total_molecules = colSums(molecules_ENSG))
total_counts_ENSG$conversion <- with(total_counts_ENSG,
                                     total_reads/total_molecules)
summary(total_counts_ENSG)
```




## Compare variances of conversion rates between batches

### ENSG

```{r}
ggplot(data.frame(total_counts_ENSG,
                  batch = anno_filter$batch),
       aes(x = factor(batch), y = conversion,
           fill = factor(batch)), height = 600, width = 2000) +
geom_violin(alpha = .5) + 
geom_boxplot(alpha = .01, width = .2, position = position_dodge(width = .9)) +
labs(x = "batch", y = "conversion rate", title = "ENSG batch effect of conversion rate") +
theme(axis.text.x = element_text(hjust=1, angle = 45))
```


*Between individual

For individual $i$, sample $j$, we have $n_{ij}$ cells. Here we compare the per cell conversion rate from molecule count to read count between the three individuals:

$$ Y_{ijk} = \mu_i + b_{ij} + \epsilon_{ijk} $$

where $i = 1, 2, 3$, $j = 1, 2, 3$, and $k = 1, 2, \dots, n_{ij}$.


```{r}
df_ENSG <- data.frame(total_counts_ENSG,
                      individual = factor(anno_filter$individual),
                      replicate = factor(anno_filter$replicate),
                      batch = factor(anno_filter$batch))

library(lme4)
lmer_ENSG_full <- lmer(conversion ~ individual + (1| individual:replicate), 
                        data = df_ENSG)
lmer_ENSG_null <- lmer(conversion ~ 1 + (1| individual:replicate), 
                        data = df_ENSG)
anova(lmer_ENSG_null, lmer_ENSG_full)
```


*For each individual, between batches.

```{r}
for (i in 1:length(unique(anno_filter$individual))) {
  print(unique(anno_filter$individual)[i])
  select_individual <- with(anno_filter, individual == unique(individual)[i])
  print( summary(aov(conversion ~ batch, 
                     data = df_ENSG[select_individual, ]) ) )
}
```



### ERCC

```{r}
ggplot(data.frame(total_counts_ERCC,
                  batch = anno_filter$batch),
       aes(x = factor(batch), y = conversion,
           fill = factor(batch)), height = 600, width = 2000) +
geom_violin(alpha = .5) + 
geom_boxplot(alpha = .01, width = .2, position = position_dodge(width = .9)) +
labs(x = "batch", y = "conversion rate", title = "ERCC batch effect of conversion rate") +
theme(axis.text.x = element_text(hjust=1, angle = 45))
```


* Between individuals

```{r}
df_ERCC <- data.frame(total_counts_ERCC,
                      individual = factor(anno_filter$individual),
                      replicate = factor(anno_filter$replicate),
                      batch = factor(anno_filter$batch))

library(lme4)
lmer_ERCC_full <- lmer(conversion ~ individual + (1| individual:replicate), 
                        data = df_ERCC)
lmer_ERCC_null <- lmer(conversion ~ 1 + (1| individual:replicate), 
                        data = df_ERCC)
anova(lmer_ERCC_null, lmer_ERCC_full)
```


*For each individual, between batches.

```{r}
for (i in 1:length(unique(anno_filter$individual))) {
  print(unique(anno_filter$individual)[i])
  select_individual <- with(anno_filter, individual == unique(individual)[i])
  print( summary(aov(conversion ~ batch, 
                     data = df_ERCC[select_individual, ]) ) )
}
```




## Session information

```{r info}
sessionInfo()
```
