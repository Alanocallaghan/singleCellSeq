<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Joyce Hsiao" />

<meta name="date" content="2015-11-17" />

<title>Per gene statistical comparison of CVs: permutation-based p-values</title>

<script src="libs/jquery-1.11.0/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.1/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.1/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.1/shim/respond.min.js"></script>

<style type="text/css">

/* padding for bootstrap navbar */
body {
  padding-top: 50px;
  padding-bottom: 40px;
}


/* offset scroll position for anchor links (for fixed navbar)  */
.section h2 {
  padding-top: 55px;
  margin-top: -55px;
}
.section h3 {
  padding-top: 55px;
  margin-top: -55px;
}



/* don't use link color in navbar */
.dropdown-menu>li>a {
  color: black;
}

/* some padding for disqus */
#disqus_thread {
  margin-top: 45px;
}

</style>

<link rel="stylesheet" href="libs/font-awesome-4.1.0/css/font-awesome.min.css"/>

<style type="text/css">code{white-space: pre;}</style>
<link rel="stylesheet"
      href="libs/highlight/textmate.css"
      type="text/css" />
<script src="libs/highlight/highlight.js"></script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img { 
  max-width:100%; 
  height: auto; 
}
</style>
<div class="container-fluid main-container">


<div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">singleCellSeq</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">About</a></li>
        <li><a href="license.html">License</a></li>
        <li><a href="https://github.com/jdblischak/singleCellSeq">GitHub</a></li>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">
<h1 class="title">Per gene statistical comparison of CVs: permutation-based p-values</h1>
<h4 class="author"><em>Joyce Hsiao</em></h4>
<h4 class="date"><em>2015-11-17</em></h4>
</div>

<div id="TOC">
<ul>
<li><a href="#objective">Objective</a></li>
<li><a href="#set-up">Set up</a></li>
<li><a href="#prepare-data">Prepare data</a></li>
<li><a href="#compute-normalized-cv">Compute normalized CV</a></li>
<li><a href="#compute-summary-measure-of-deviation">Compute summary measure of deviation</a></li>
<li><a href="#compute-permuted-p-vals">Compute permuted p-vals</a></li>
<li><a href="#sanity-checks-on-the-permuted-p-values">Sanity checks on the permuted p-values</a></li>
<li><a href="#session-information">Session information</a></li>
</ul>
</div>

<p><strong>Last updated:</strong> 2015-12-11</p>
<p><strong>Code version:</strong> 7a25b2aef5c8329d4b5394cce595bbfc2b5b0c3e</p>
<div id="objective" class="section level2">
<h2>Objective</h2>
<p>Quantify statistical significance of individual differences between adjusted CVs.</p>
<p>We permuted the wells labels across samples for 10,000 times. Then, for each gene, we computed the number of permuted samples produced larger distance than the observed distance between standardized coefficients of variance between individuals.</p>
</div>
<div id="set-up" class="section level2">
<h2>Set up</h2>
<pre class="r"><code>library(&quot;data.table&quot;)
library(&quot;dplyr&quot;)
library(&quot;limma&quot;)
library(&quot;edgeR&quot;)
library(&quot;ggplot2&quot;)
library(&quot;grid&quot;)
library(&quot;Humanzee&quot;)
theme_set(theme_bw(base_size = 12))
source(&quot;functions.R&quot;)</code></pre>
</div>
<div id="prepare-data" class="section level2">
<h2>Prepare data</h2>
<p>Input annotation of only QC-filtered single cells. Remove NA19098.r2</p>
<pre class="r"><code>anno_filter &lt;- read.table(&quot;../data/annotation-filter.txt&quot;, 
                    header = TRUE,
                    stringsAsFactors = FALSE)
dim(anno_filter)</code></pre>
<pre><code>[1] 568   5</code></pre>
<p>Import endogeneous gene molecule counts that are QC-filtered, CPM-normalized, ERCC-normalized, and also processed to remove unwanted variation from batch effet. ERCC genes are removed from this file.</p>
<pre class="r"><code>molecules_ENSG &lt;- read.table(&quot;../data/molecules-final.txt&quot;, 
                             header = TRUE, stringsAsFactors = FALSE)
stopifnot(NCOL(molecules_ENSG) == NROW(anno_filter))</code></pre>
</div>
<div id="compute-normalized-cv" class="section level2">
<h2>Compute normalized CV</h2>
<p>We compute squared CV across cells for each individual and then for each individual CV profile, account for mean dependency by computing distance with respect to the data-wide coefficient variation on the log10 scale.</p>
<pre class="r"><code>ENSG_cv &lt;- Humanzee::compute_cv(log2counts = molecules_ENSG,
                      grouping_vector = anno_filter$individual)

ENSG_cv_adj &lt;- Humanzee::normalize_cv(group_cv = ENSG_cv, 
                            log2counts = molecules_ENSG, 
                            anno = anno_filter)</code></pre>
</div>
<div id="compute-summary-measure-of-deviation" class="section level2">
<h2>Compute summary measure of deviation</h2>
<ul>
<li>Standardize the each CV vectors</li>
</ul>
<p>Individual CV vectors are standarized for individual CV mean and coefficients of variation across genes.</p>
<pre class="r"><code>df_cv &lt;- data.frame(NA19098 = ENSG_cv_adj[[1]]$log10cv2_adj,
                    NA19101 = ENSG_cv_adj[[2]]$log10cv2_adj,
                    NA19239 = ENSG_cv_adj[[3]]$log10cv2_adj)

library(matrixStats)
df_norm &lt;- sweep(df_cv, MARGIN = 2, STATS = colMeans(as.matrix(df_cv)), FUN = &quot;-&quot;)
df_norm &lt;- sweep(df_norm, MARGIN = 2, STATS = sqrt(colVars(as.matrix(df_cv))), FUN = &quot;/&quot;)
colnames(df_norm) &lt;- names(ENSG_cv_adj)</code></pre>
<ul>
<li>SSM and SAM</li>
</ul>
<p>Compute metrics for quantifying similarity between the three individual coefficients of variation.</p>
<pre class="r"><code>library(matrixStats)

df_norm &lt;- as.data.frame(df_norm)
df_norm$squared_dev &lt;- rowSums( ( df_norm - rowMedians(as.matrix(df_norm)) )^2 )
df_norm$abs_dev &lt;- rowSums(abs( df_norm - rowMedians(as.matrix(df_norm)) ))</code></pre>
</div>
<div id="compute-permuted-p-vals" class="section level2">
<h2>Compute permuted p-vals</h2>
<p>Export some rdas.</p>
<pre class="r"><code>if (!file.exists(&quot;rda/cv-adjusted-statistical-test-permute/adj-cv.rda&quot;)) {
  save(df_norm, file = &quot;rda/cv-adjusted-statistical-test-permute/adj-cv.rda&quot;)
}


if (!file.exists(&quot;rda/cv-adjusted-statistical-test-permute/permute-cv-test.rda&quot;)) {
  save(molecules_ENSG, anno_filter,
       file = &quot;rda/cv-adjusted-statistical-test-permute/permute-cv-test.rda&quot;)
}</code></pre>
<p>Compute permuted distances for each gene.</p>
<pre class="bash"><code>sbatch ../code/permuted-cv-test.sbatch</code></pre>
<p>Compute permutation-based p-values for each gene.</p>
<pre class="bash"><code>sbatch ../code/permuted-cv-compute-pval.sbatch</code></pre>
</div>
<div id="sanity-checks-on-the-permuted-p-values" class="section level2">
<h2>Sanity checks on the permuted p-values</h2>
<p>Confirm that the gene with the larger SSM and SAM are significant with a p-value of 0.</p>
<pre class="r"><code>load(&quot;rda/cv-adjusted-statistical-test-permute/permuted-pval.rda&quot;)
permuted_pval$squared_dev[which.max(df_norm$squared_dev)]</code></pre>
<pre><code>[1] 0</code></pre>
<pre class="r"><code>permuted_pval$squared_dev[order(df_norm$squared_dev, decreasing = T)[3]]</code></pre>
<pre><code>[1] 0</code></pre>
<pre class="r"><code>library(ggplot2)
ggplot(data.frame(pvals = permuted_pval$squared_dev,
                  dist = df_norm$squared_dev),
       aes(x = dist, y = pvals)) +
  geom_point()</code></pre>
<p><img src="figure/cv-adjusted-statistical-test-permute.Rmd/ssm-pvalue-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
<p>Gene with the largest Sum-of-Squared-Deviations.</p>
<pre class="r"><code>ggplot(do.call(rbind, ENSG_cv_adj),
       aes(x = log10(mean), y = log10cv2_adj)) +
  geom_point(aes(col = group), cex = .8) + facet_wrap( ~ group) +
  ggtitle(&quot;Gene with the largest SSM&quot;) + 
  geom_point(data = subset(do.call(rbind, ENSG_cv_adj), 
                           c(1:NROW(ENSG_cv_adj[[1]])) %in% 
                             order(df_norm$squared_dev, decreasing = TRUE )[1]), 
             colour = &quot;grey20&quot;)</code></pre>
<p><img src="figure/cv-adjusted-statistical-test-permute.Rmd/unnamed-chunk-1-1.png" title="" alt="" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="session-information" class="section level2">
<h2>Session information</h2>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>R version 3.2.1 (2015-06-18)
Platform: x86_64-apple-darwin13.4.0 (64-bit)
Running under: OS X 10.10.5 (Yosemite)

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] grid      stats     graphics  grDevices utils     datasets  methods  
[8] base     

other attached packages:
[1] matrixStats_0.15.0 zoo_1.7-12         Humanzee_0.1.0    
[4] ggplot2_1.0.1      edgeR_3.10.5       limma_3.24.15     
[7] dplyr_0.4.3        data.table_1.9.6   knitr_1.11        

loaded via a namespace (and not attached):
 [1] Rcpp_0.12.2      magrittr_1.5     MASS_7.3-45      munsell_0.4.2   
 [5] lattice_0.20-33  colorspace_1.2-6 R6_2.1.1         stringr_1.0.0   
 [9] plyr_1.8.3       tools_3.2.1      parallel_3.2.1   gtable_0.1.2    
[13] DBI_0.3.1        htmltools_0.2.6  yaml_2.1.13      assertthat_0.1  
[17] digest_0.6.8     reshape2_1.4.1   formatR_1.2.1    evaluate_0.8    
[21] rmarkdown_0.8.1  labeling_0.3     stringi_1.0-1    scales_0.3.0    
[25] chron_2.3-47     proto_0.3-10    </code></pre>
</div>


<!-- some extra javascript for older browsers -->
<script type="text/javascript" src="libs/polyfill.js"></script>

<script>

// manage active state of menu based on current page
$(document).ready(function () {

    // active menu
    href = window.location.pathname
    href = href.substr(href.lastIndexOf('/') + 1)
    $('a[href="' + href + '"]').parent().addClass('active');

    // manage active menu header
    if (href.startsWith('authoring_'))
      $('a[href="' + 'authoring' + '"]').parent().addClass('active');
    else if (href.endsWith('_format.html'))
      $('a[href="' + 'formats' + '"]').parent().addClass('active');
    else if (href.startsWith('developer_'))
      $('a[href="' + 'developer' + '"]').parent().addClass('active');

});

</script>

</div>

<script>

// add bootstrap table styles to pandoc tables
$(document).ready(function () {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
});

</script>


</body>
</html>
