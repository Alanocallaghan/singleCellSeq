---
title: "Cell-cycle before/after corrections"
author: "Joyce Hsiao"
date: 2016-01-12
---

**Last updated:** `r Sys.Date()`

**Code version:** `r system("git log -1 --format='%H'", intern = TRUE)`

```{r chunk-options, include=FALSE}
source("chunk-options.R")
```


## Objective 

Compute cell-cycle phase assignment before and after normalization and corrections. Also to plot total molecule count by cell-cycle phase. 

## Setup

```{r}
source("functions.R")
require("limma")
require("edgeR")
require(ggplot2)
require(dplyr)
require(data.table)
theme_set(theme_bw(base_size = 12))
```


## Import data

```{r}
## Annotation of the filtered data
anno_filter <- read.table("../data/annotation-filter.txt",
                         header = TRUE,
                         stringsAsFactors = FALSE)

## Molecule counts of the filtered data
molecules_filter <- read.table("../data/molecules-final.txt",
                               header = TRUE,
                               stringsAsFactors = FALSE)

## Molecule counts after all corrections
molecules_final <- read.table("../data/molecules-final-pois.txt",
                              header = TRUE,
                              stringsAsFactors = FALSE)
```

## Cell-cycle assignemnt

Import cell-cycle information

```{r}
cell_cycle_genes <- read.table("../data/cellcyclegenes.txt",
                               header = TRUE, sep = "\t",
                               stringsAsFactors = FALSE)
colnames(cell_cycle_genes) <- c("G1.S","S","G2","G2.M","M.G1")
```


Cell-phase assignment helper

```{r cell-phase-helper}
cell_phase_assign <- function(cell_cycle_genes, molecules_final) {

  cell_phase_score <- sapply(cell_cycle_genes, function(xx){
    ## create table of each phase
    molecules_phase <- molecules_final[rownames(molecules_final) %in% unlist(xx) ,]
  
    ## add average count of all genes in the phase
    combined_matrix <- rbind(molecules_phase, average = apply(molecules_phase,2,mean) )
    
    ## use transpose to compute cor matrix
    cor_matrix <- cor(t(combined_matrix))
    
    ## take the numbers
    cor_vector <- cor_matrix[,dim(cor_matrix)[1]]
    
    ## restrict to correlation >= 0.3 
    molecules_phase_restricted <- molecules_phase[rownames(molecules_phase) %in% names(cor_vector[cor_vector >= 0.3]),]
    
    ## output the phase specific scores (mean of normalized expression levels in the phase)
    apply(molecules_phase_restricted, 2, mean)
  })

  ## Two-step normalization (by gene and by cell)
  ## by row (gene)
  row_mean <- apply(cell_phase_score, 1, mean)
  row_sd   <- apply(cell_phase_score, 1, sd)
  score_row_normed <- do.call(rbind, 
      lapply(1:dim(cell_phase_score)[1], function(i) {
          (cell_phase_score[i,] - row_mean[i])/row_sd[i]
      })  )
  
  ## by column
  col_mean <- apply(score_row_normed, 2, mean)
  col_sd   <- apply(score_row_normed, 2, sd)
  score_final_normed <- do.call(cbind, 
      lapply(1:dim(score_row_normed)[2], function(i) {
          (score_row_normed[, i] - col_mean[i])/col_sd[i]
      })
  )
  return(score_final_normed)
}
```

Assign phase

```{r}
cell_phase_before <- apply(
      cell_phase_assign(cell_cycle_genes, molecules_filter), 
      1, function(x) colnames(cell_cycle_genes)[which.max(x)])

cell_phase_after <- apply(
      cell_phase_assign(cell_cycle_genes, molecules_final), 
      1, function(x) colnames(cell_cycle_genes)[which.max(x)])

phase_order <- c("G1.S","S","G2","G2.M","M.G1")
cell_phase_before <- factor(cell_phase_before, 
                            levels = phase_order)
cell_phase_after <- factor(cell_phase_after,
                           levels = phase_order)
```

Average total number of molecules of the cells assigned to each phase

```{r}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

data_to_plot <- anno_filter
data_to_plot$cell_phase_before <- cell_phase_before
data_to_plot$cell_phase_after <- cell_phase_after
data_to_plot$total_molecules_before <- apply(molecules_filter, 2, sum)
data_to_plot$total_molecules_after <- apply(molecules_final, 2, sum)

data_to_plot$individual <- factor(data_to_plot$individual)
data_to_plot$replicate <- factor(data_to_plot$replicate)

data_before <- summarise(group_by(data_to_plot, cell_phase_before, individual, replicate),
          mean_total_molecules = mean(total_molecules_before))
data_after <- summarise(group_by(data_to_plot, cell_phase_after, individual, replicate),
          mean_total_molecules = mean(total_molecules_after))
```

Before correction

```{r}
cycle_plot_before <- ggplot(data_before, aes(x = as.factor(cell_phase_before), 
                                             y = mean_total_molecules,
                                             color = replicate,
                                             group = replicate) ) + 
                        geom_point() + geom_line() +
                        scale_x_discrete(limits=phase_order, labels=c("G1/S","S","G2","G2/M","M/G1")) + 
                        theme(axis.text.x = element_text(angle = 90, hjust = 0.9, vjust = 0.5)) + 
                        xlab("Cell cycle phase") + ylab("Total molecules") +
                        ggtitle("Before correction")
cycle_plot_before + facet_grid(~ individual)
```


After correction

```{r}
cycle_plot_after <- ggplot(data_after, aes(x = as.factor(cell_phase_after), 
                                             y = mean_total_molecules,
                                             color = replicate,
                                             group = replicate) ) + 
                        geom_point() + geom_line() +
                        scale_x_discrete(limits=phase_order, labels=c("G1/S","S","G2","G2/M","M/G1")) + 
                        theme(axis.text.x = element_text(angle = 90, hjust = 0.9, vjust = 0.5)) + 
                        xlab("Cell cycle phase") + ylab("Total molecules") +
                        ggtitle("Post correction")
cycle_plot_after + facet_grid(~ individual)
```



## Session information

```{r info}
sessionInfo()
```
