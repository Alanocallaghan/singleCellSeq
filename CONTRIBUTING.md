# How to contribute

## Outline

*  [Running RStudio Server](#running-rstudio-server)
*  [Creating a new analysis](#creating-a-new-analysis)
*  [Style guide](#style-guide)
*  [Adding figures](#adding-figures)
*  [Building the site](#building-the-site)

## Running RStudio Server

After ssh'ing into spudhead, request an interactive session with sufficient memory.

```bash
ql 8g
```

Next start an instance of RStudio Server running in the background:

```bash
rstudio-start
```

`rstudio-start` is an alias for the following:

```bash
rserver --auth-none 0 --auth-validate-users 1 --auth-required-user-group $USER &
```

Then on your local computer, run the following:

```bash
ssh -N -f -L localhost:8787:spudling##:8787 user-name@pps-gateway.uchicago.edu
```

replacing spudling## with the name of the spudling where you started the RStudio Server instance, e.g. `spudling87` or `bigmem01`, and user-name with your login ID.

Open a browser to the address http://127.0.0.1:8787/.
Enter your username and password to access your RStudio instance.
From here, you can choose "Open Project" and select `singleCellSeq.Rproj`.

When you're finished, you can close the browser tab, and then kill the RStudio instance.

```bash
rstudio-end
```

`rstudio-end` is an alias for the following:

```bash
pkill rserver && pkill rsession
```

If you re-start RStudio Server, you may receive a message about an error due to an unexpected crash.
This is not a problem as long as you purposefully ran `rstudio-end` after having saved your files.

If you have trouble starting a new RStudio instance, remove all RStudio-related temporary files:

```bash
rstudio-clean
```

`rstudio-clean` is an alias for the following:

```bash
rm ~/.rstudio -r && rm /tmp/rstudio* -r
```

## Creating a new analysis

Here are the steps for creating a new analysis:

*  Open RStudio project `singleCellSeq.Rproj`.
*  Set working directory to `analysis` with `setwd` or "Session" -> "Set Working Directory" -> "To Files Pane Location".
*  Create a copy of [template.Rmd][].
*  Change the author, title, and date at the top of the file.
*  Add the analysis code.
*  Use the RStudio button "Preview HTML" to view the results.
*  Add the analysis to the list in [index.Rmd][].
*  Add, commit, and push the new analysis.

```bash
cd analysis
git add new-analysis.Rmd index.Rmd
git commit -m "Add new analysis on..."
git push origin master
```

[template.Rmd]: https://raw.githubusercontent.com/jdblischak/singleCellSeq/master/analysis/template.Rmd
[index.Rmd]: https://raw.githubusercontent.com/jdblischak/singleCellSeq/master/analysis/index.Rmd

## Style guide

For consistency, we'll use the following conventions:

*  Name variables using snakecase, e.g. `gene_exp_mat`.
*  Name files with dashes, e.g. `this-is-a-long-filename.txt`.
*  Name directories with camelCase, e.g `data`, `rawData`.
*  Use `<-` for assignment.
*  Surround binary operators with spaces, e.g. `1 + 1`, not `1+1`.
*  Use two spaces for indentation.
*  Lines should not be longer than 80 characters.

When in doubt, use the style indicated either in [Google's R Style Guide][google-style] or [Hadley's R Style Guide][hadley-style].

When writing text, aim to write one sentence per line.
This makes it easier to understand edits when reviewing the version control log.
The limit of 80 characters for code described above does not need to be applied to text.

[google-style]: https://google-styleguide.googlecode.com/svn/trunk/Rguide.xml
[hadley-style]: http://r-pkgs.had.co.nz/style.html

## Adding figures

We have configured knitr so that plots are automatically saved according to the following format: `analysis/figure/<filename>/<chunk-name>.png`, e.g. `analysis/figure/total-counts.Rmd/counts-by-variables-1.png`.
Since these are generated by the code, they only appear in the [gh-pages](https://github.com/jdblischak/singleCellSeq/tree/gh-pages) branch.

To add your own custom figure, follow the same format.
First create a subdirectory in `figure`:

```bash
mkdir -p analysis/figure/<filename>.Rmd
```

Then add your figure to this directory.
To display the figure in your file, use the following markdown syntax:

```
![Text to display when hovering over fig](figure/<filename>.Rmd/<figurename>.png)
```

By default we have Git ignore png files.
To overide this behavior to add specific image files, use the `-f` flag (for force):

```bash
git add -f analysis/figure/<filename>.Rmd/<figurename>.png
```

## Building the site

```bash
git checkout gh-pages
git merge master
cd analysis
make
git add -f *html figure/*
git commit -m "Build site."
git push origin gh-pages
```
